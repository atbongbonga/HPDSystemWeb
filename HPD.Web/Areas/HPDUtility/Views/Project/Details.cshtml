
@{
    Layout = "~/Areas/HPDUtility/Views/Shared/_Layout.cshtml";
}

    <!-- Begin Page Content -->
    <div class="container-fluid">

                <!-- Page Heading -->
                <h1 class="h3 mb-4 text-gray-800">Project Details</h1>

                <div class="row">
                    <div class="col-lg-12">
                        <!-- Basic Card Example -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Boards</h6>
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-tabs" id="myTab" role="tablist">
                                   
                                    <li class="nav-item">
                                        <a class="active nav-link text-success" id="sprint-tab" data-toggle="tab" href="#sprinttab" role="tab" aria-controls="sprinttab" aria-selected="false">Sprint</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link text-warning" id="bugs-tab" data-toggle="tab" href="#bugtab" role="tab" aria-controls="bugtab" aria-selected="true">Bug Report</a>
                                    </li>

                                </ul>
                                <div class="tab-content" id="myTabContent">
                                   
                                    <div class="show active tab-pane fade py-1" id="sprinttab" role="tabpanel" aria-labelledby="sprint-tab">
                                        
                                        <div class="d-sm-flex align-items-center justify-content-between mb-4 py-1">
                                            <h1 class="h3 mb-0 text-gray-800">BP Sprints</h1>
                                            <a href="#" class="d-sm-inline-block btn btn-success btn-circle shadow-sm" id="addNewSprint"><i class="fas fa-plus fa-sm"></i></a>
                                        </div>
                                        <div class="row py-1" id="projectSprintTileContainer">
                                            

                                        </div><hr>
                                        <div class="d-sm-flex align-items-center justify-content-between mb-4 py-1">
                                            <h1 class="h3 mb-0 text-gray-800">Other Sprints</h1>
                                            @*<a href="#" class="d-sm-inline-block btn btn-success btn-circle shadow-sm" id="addNewSprint"><i class="fas fa-plus fa-sm"></i></a>*@
                                        </div>
                                        <div class="row py-1" id="otherSprintTileContainer">

                                        </div>
                                    </div>
                                    <div class="tab-pane fade py-1" id="bugtab" role="tabpanel" aria-labelledby="bugs-tab">
                                        <div class="d-sm-flex align-items-center justify-content-between mb-4 py-1">
                                            <h1 class="h3 mb-0 text-gray-800">Bug Reports</h1>
                                            @*<a href="#" class="d-none d-sm-inline-block btn btn-sm btn-success shadow-sm"><i class="fas fa-plus fa-sm text-white-50"></i>Add New Task</a>*@
                                        </div>
                                        <div class="row">
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <div id="dataTable_wrapper" class="dataTables_wrapper dt-bootstrap4">
                                                        <div class="col-sm-12">
                                                            <table id="bugTable" class="table table-striped table-bordered" style="width:100%">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Error Code</th>
                                                                        <th>Error Message</th>
                                                                        <th>Doc Date</th>
                                                                        <th>Action</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="bugTableBody"></tbody>
                                                                @*<tfoot>
                                                                    <tr>
                                                                        <th>Error Code</th>
                                                                        <th>Error Message</th>
                                                                        <th>Doc Date</th>
                                                                        <th>Action</th>
                                                                    </tr>
                                                                </tfoot>*@
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>




                <!-- /.container-fluid -->
            </div>
    <!-- End of Main Content -->

    <!-- Add New Sprint Modal-->
    <div class="modal fade" id="addNewSprintModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add New Sprint</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div id="addNewSprintForm">
                            <form class="user" id="formANS">
                                <div class="form-group row">
                                    <div class="col-sm-6">
                                        <label for="txtANSTitle"><b>Title</b></label>
                                        <input type="text" class="form-control input-sm" id="txtANSTitle" required placeholder="Title" name="ANSTitle"  style="border-radius: 0 !important;">
                                    </div>
                                    <div class="col-sm-6">
                                        <label for="txtANSProgramName"><b>Program Name</b></label>
                                        <input type="text" class="form-control input-sm" id="txtANSProgramName" disabled placeholder="Program"  style="border-radius: 0 !important;">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-lg-12">
                                        <label for="msANSMember"><b>Member</b></label>
                                        <select class="form-control input-sm multipleSelect" multiple name="Developer" id="msANSMember" placeholder="Member">

                                        </select>
                                    </div>
                                    
                                </div>
                                <div class="form-group row">
                                    <div class="col-sm-6">
                                        <label for="txtANSSDate"><b>Start Date</b></label>
                                        <input type="date" class="form-control input-sm" id="txtANSSDate" required placeholder="Start Date" style="border-radius: 0 !important;">
                                    </div>
                                    <div class="col-sm-6">
                                        <label for="txtANSEDate"><b>End Date</b></label>
                                        <input type="date" class="form-control input-sm" id="txtANSEDate" required placeholder="End Date" style="border-radius: 0 !important;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="txtANSEDate"><b>Blue Print</b></label>
                                    <input type="text" class="form-control input-sm" id="txtANSBP" required placeholder="Blue Print Path" style="border-radius: 0 !important;">
                                   
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <form class="user">
                        <div class="form-group row">
                            <div class="col-sm-6">
                                <a href="#" class="btn btn-primary" id="btnANSSave">Save
                                    @*<i class="fas fa-save"></i>*@
                                </a>
                            </div>
                            @*<div class="col-sm-6">
                                <a href="#" class="btn btn-danger">Delete
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>*@
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Program Bug Details -->
    <div class="modal fade" id="programBugDetailModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Bug Detail for Error Code <span class="text-warning" id="bugErrorCodeTxt"></span></h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <h5 class="card-title">Error Code</h5>
                    <p class="card-text" id="pbdmerrorcode"></p>
                    <h5 class="card-title">Error Message</h5>
                    <p class="card-text" id="pbdmerrormsg"></p>
                    <h5 class="card-title">Error Details</h5>
                    <p class="card-text" id="pbdmerrordtls"></p>
                    <h5 class="card-title">Error Solution</h5>
                    <div class="form-group">
                        @*<label for="exampleFormControlTextarea1">Example textarea</label>*@
                        <textarea class="form-control" id="pbdmtxtareaerrorsol" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="form-group row">
                    <div class="col-md-12 row">
                        <div class="col-sm-10">
                            <button class="btn btn-warning" id="btnPBDMAAE" data-id="">
                                Add To Exception
                            </button>
                        </div>
                        <div class="col-sm-2">
                            <button class="btn btn-success" id="btnPBDMFix" data-id="">
                                Fix
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!--Fix bug error toast-->
    
    
    @section scripts
{
        <script>
        $(document).ready(function () {


            window.addEventListener("pageshow", function (event) {
                var historyTraversal = event.persisted ||
                    (typeof window.performance != "undefined" &&
                        window.performance.navigation.type === 2);
                if (historyTraversal) {
                    // Handle page restore.
                    window.location.reload();
                }
            });


            var ProjectName = "@ViewBag.Message";

            $('.multipleSelect').fastselect();

            $.post("@Url.Action("GetDeveloper", "Project")", function (data) {
                var devList = $('#msANSMember');
                devList.empty();
                data = JSON.parse(data);
                $(data).each(function (index, dev) {
                    devList.append(
                        '<option value="' + dev.EmpCode + '">' + dev.EmpName + '</option>'
                    );
                });
            });

            var GetBugList = $("#bugTable").DataTable({
                    "processing": true,
                    "serverSide": true,
                    "filter": true,
                    "pageLength": 10,
                    "ajax": {
                        "url": "@Url.Action("GetErrorListByProgram", "Project")",
                        "data": {
                            "ProgramName": ProjectName
                        },
                        "type": "POST",
                        "datatype": "json"
                    },
                    "columns": [
                        { "data": "ErrCode", "autoWidth": true },
                        { "data": "ErrMsg", "autoWidth": true },
                        {
                            "render": function (data, type, full, meta) {
                                var nowDate = new Date(parseInt(full.DocDate.substr(6))).format("mm/dd/yyyy");
                                return nowDate;
                            }
                        },
                        {
                            "data": null, render: function (data, type, row) {
                                return "<button data-id='" + data.DocEntry + "' class='btn btn-circle btn-sm btn-secondary btnBugDetail'><i class='fas fa-cog fa-sm'></i></button>";

                            }
                        },
                    ]
            });

            GetBugList.ajax.reload();
            var GetProjectSprintList = function () {

                 $.post("@Url.Action("GetProjectSprintList", "Project")", { ProgramName: ProjectName }, function (data) {
                     var sprintCard = $('#projectSprintTileContainer');
                     var othersprintCard = $('#otherSprintTileContainer');
                     sprintCard.empty();
                     othersprintCard.empty();
                     data = JSON.parse(data);

                     $(data).each(function (index, sprint) {
                        if (sprint.IsBP) {
                            sprintCard.append(
                                '<div class="col-xl-3 col-md-6 mb-4 projectSprintCard" data-id="' + sprint.Id + '">' +
                                '<div class="card border-left-primary shadow h-100 py-2">' +
                                '<div class="card-header">' +
                                '<h6 class="m-0 font-weight-bold text-primary">' + sprint.Title + '</h6>' +
                                '</div>' +
                                '<div class="card-body">' +
                                '<div class="row no-gutters align-items-center">' +
                                '<div class="col mr-2">' +
                                '<div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Bugs</div>' +
                                '<div class="h5 mb-0 font-weight-bold text-gray-800">' + sprint.BugCount + '</div>' +
                                '</div>' +
                                '<div class="col">' +
                                '<div class="progress progress-sm mr-2">' +
                                '<div class="progress-bar bg-danger" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>' +
                                '</div>' +
                                '</div>' +
                                '<div class="col-auto">' +
                                '<i class="fas fa-bug fa-2x text-gray-300"></i>' +
                                '</div>' +
                                '</div>' +
                                '<div class="row no-gutters align-items-center">' +
                                '<div class="col mr-2">' +
                                '<div class="text-xs font-weight-bold text-success text-uppercase mb-1">Task</div>' +
                                '<div class="h5 mb-0 font-weight-bold text-gray-800">' + sprint.TaskCount + '</div>' +
                                '</div>' +
                                '<div class="col">' +
                                '<div class="progress progress-sm mr-2">' +
                                '<div class="progress-bar bg-success" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>' +
                                '</div>' +
                                '</div>' +
                                '<div class="col-auto">' +
                                '<i class="fas fa-tasks fa-2x text-gray-300"></i>' +
                                '</div>' +
                                '</div>' +
                                '</div>' +
                                '</div>' +
                                '</div>'
                            );
                        }
                        else
                        {
                            othersprintCard.append(
                                '<div class="col-xl-3 col-md-6 mb-4 projectSprintCard" data-id="' + sprint.Id + '">' +
                                '<div class="card border-left-primary shadow h-100 py-2">' +
                                '<div class="card-header">' +
                                '<h6 class="m-0 font-weight-bold text-primary">' + sprint.Title + '</h6>' +
                                '</div>' +
                                '<div class="card-body">' +
                                '<div class="row no-gutters align-items-center">' +
                                '<div class="col mr-2">' +
                                '<div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Bugs</div>' +
                                '<div class="h5 mb-0 font-weight-bold text-gray-800">' + sprint.BugCount + '</div>' +
                                '</div>' +
                                '<div class="col">' +
                                '<div class="progress progress-sm mr-2">' +
                                '<div class="progress-bar bg-danger" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>' +
                                '</div>' +
                                '</div>' +
                                '<div class="col-auto">' +
                                '<i class="fas fa-bug fa-2x text-gray-300"></i>' +
                                '</div>' +
                                '</div>' +
                                '<div class="row no-gutters align-items-center">' +
                                '<div class="col mr-2">' +
                                '<div class="text-xs font-weight-bold text-success text-uppercase mb-1">Task</div>' +
                                '<div class="h5 mb-0 font-weight-bold text-gray-800">' + sprint.TaskCount + '</div>' +
                                '</div>' +
                                '<div class="col">' +
                                '<div class="progress progress-sm mr-2">' +
                                '<div class="progress-bar bg-success" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>' +
                                '</div>' +
                                '</div>' +
                                '<div class="col-auto">' +
                                '<i class="fas fa-tasks fa-2x text-gray-300"></i>' +
                                '</div>' +
                                '</div>' +
                                '</div>' +
                                '</div>' +
                                '</div>'
                            );
                        }
                    });
                });
            };
            GetProjectSprintList();

            $("#addNewSprint").on("click", function () {

                var mindate = new Date().toISOString().split('T')[0];
                var currentDate = new Date().toISOString().slice(0, 10);

                $('#addNewSprintModal').modal('toggle');
                $("#txtANSProgramName").val("@ViewBag.Message");
                $("#txtANSSDate").val(currentDate);
                $("#txtANSSDate").attr('min', currentDate);
                $("#txtANSEDate").val(currentDate);
                $("#txtANSEDate").attr('min', currentDate);

            });

            $("#btnANSSave").on("click", function () {
                $(this).attr("disabled", true);
                var programname = $("#txtANSProgramName").val();
                var title = $("#txtANSTitle").val();
                var member = $("#msANSMember").val();
                var sdate = $("#txtANSSDate").val();
                var edate = $("#txtANSEDate").val();
                var bp = $("#txtANSBP").val();
                if (programname == "" || title == "" || member == "" || bp == "") {
                    $(this).removeAttr("disabled");
                    alert("Invalid Information");
                }
                else
                {
                    $.post("@Url.Action("CreateProjectSprint", "Project")", { ProgramName: programname, Title: title, Member: member.toString(), StartDate: sdate, EndDate: edate, BP: bp}, function (data) {
                        if (data) {

                            $('#addNewSprintModal').modal('toggle');
                            $(this).removeAttr("disabled");
                            GetProjectSprintList();
                        }
                    });

                }

            });

            $(document).on('click', '.projectSprintCard', function () {
                sprintId = $(this).attr("data-id");
                location.href = '@Url.Action("Sprint", "Project")?Id='+sprintId+'';
            });

            $(document).on('click', '.btnBugDetail', function () {
                var docEntry = $(this).attr("data-id");
                $.post("@Url.Action("GetErrorByDocEntry", "Project")", { docEntry: docEntry }, function (data) {
                    data = JSON.parse(data);

                    $("#bugErrorCodeTxt").text(data.ErrCode);
                    $("#btnPBDMFix").attr("data-id", data.ErrCode);
                    $("#pbdmerrorcode").text(data.ErrCode);
                    $("#pbdmerrormsg").text(data.ErrMsg);
                    $("#pbdmerrordtls").text(data.ErrDtls);

                    $.post("@Url.Action("GetErrorSolution", "Project")", { errorCode: data.ErrCode }, function (data) {
                        $("#pbdmtxtareaerrorsol").val(data)
                    });

                });

                $('#programBugDetailModal').modal('toggle');
            });

            $("#btnPBDMFix").on("click", function () {
                //var docEntry = $(this).attr("data-id");
                var errorCode = $(this).attr("data-id");
                var errorSol = $("#pbdmtxtareaerrorsol").val();
                $.post("@Url.Action("FixProgramBug", "Project")", { errorCode: errorCode, errorSol: errorSol, program: ProjectName}, function (data) {
                    data = JSON.parse(data);
                    if (data === true) {
                        GetBugList.ajax.reload(null, false);
                        $('#programBugDetailModal').modal('toggle');
                        toastr.success("Error Code " + errorCode + " Successfully Fixed", "Bug fix");
                    }
                    else
                    {
                        toastr.warning("Error Code" + errorCode + " Can't Fix", "Bug fix");
                    }

                });
            });

            $("#btnPBDMAAE").on("click", function () {
                var errorCode = $("#pbdmerrorcode").text();
                var errorDesc = $("#pbdmerrormsg").text();
                $.post("@Url.Action("AddBugToErrorException", "Project")", { errorCode: errorCode, errorDesc: errorDesc }, function (data) {
                    data = JSON.parse(data);
                    console.log(data);
                    if (data === true) {
                        GetBugList.ajax.reload(null, false);
                        $('#programBugDetailModal').modal('toggle');
                        toastr.success("Bug #" + errorCode + " Successfully Added", "Bug Exception");
                    }
                    else
                    {
                        toastr.warning("Bug #" + errorCode + " Can't add", "Bug Exception");
                    }

                });
            });

        });
        </script>
    }


